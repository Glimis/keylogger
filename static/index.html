<html>
<header>
    <script src="https://cdn.bootcss.com/echarts/4.7.0/echarts.min.js"></script>
</header>

<body>
    <div>
        <div id="main" style="width: 600px;height:400px;"></div>
    </div>
</body>

<script>
    var myChart = echarts.init(document.getElementById('main'));
    var data = [{ "x": "2020-04-12T08:04:20.036Z", "y": 16 }, { "x": "2020-04-12T08:07:45.180Z", "y": 16 }, { "x": "2020-04-12T10:20:56.503Z", "y": 3 }, { "x": "2020-04-12T10:21:53.240Z", "y": 12 }, { "x": "2020-04-12T10:22:13.684Z", "y": 5 }, { "x": "2020-04-12T10:24:24.887Z", "y": 22 }, { "x": "2020-04-12T10:26:33.373Z", "y": 35 }, { "x": "2020-04-12T10:27:06.788Z", "y": 15 }, { "x": "2020-04-12T10:51:29.823Z", "y": 23 }, { "x": "2020-04-12T10:52:00.500Z", "y": 39 }, { "x": "2020-04-12T10:53:00.043Z", "y": 6 }, { "x": "2020-04-12T10:54:05.537Z", "y": 71 }, { "x": "2020-04-12T10:56:29.367Z", "y": 43 }, { "x": "2020-04-12T10:57:03.271Z", "y": 36 }, { "x": "2020-04-12T10:58:03.026Z", "y": 39 }, { "x": "2020-04-12T10:59:00.964Z", "y": 13 }, { "x": "2020-04-12T11:00:13.876Z", "y": 29 }, { "x": "2020-04-12T11:02:54.840Z", "y": 8 }, { "x": "2020-04-12T11:03:00.779Z", "y": 40 }, { "x": "2020-04-12T11:04:25.479Z", "y": 3 }, { "x": "2020-04-12T11:10:14.092Z", "y": 23 }, { "x": "2020-04-12T11:11:28.603Z", "y": 26 }, { "x": "2020-04-12T11:13:16.218Z", "y": 8 }, { "x": "2020-04-12T11:14:17.790Z", "y": 44 }, { "x": "2020-04-12T11:15:00.119Z", "y": 69 }, { "x": "2020-04-12T11:18:47.971Z", "y": 32 }, { "x": "2020-04-12T11:20:00.289Z", "y": 94 }, { "x": "2020-04-12T11:21:00.532Z", "y": 205 }, { "x": "2020-04-12T11:22:00.056Z", "y": 188 }, { "x": "2020-04-12T11:23:00.727Z", "y": 158 }, { "x": "2020-04-12T11:24:16.718Z", "y": 122 }, { "x": "2020-04-12T11:25:00.093Z", "y": 187 }, { "x": "2020-04-12T11:26:00.009Z", "y": 135 }, { "x": "2020-04-12T11:27:16.251Z", "y": 34 }, { "x": "2020-04-12T11:28:03.445Z", "y": 104 }, { "x": "2020-04-12T11:30:45.643Z", "y": 8 }, { "x": "2020-04-12T11:32:35.714Z", "y": 16 }, { "x": "2020-04-12T11:33:00.110Z", "y": 42 }, { "x": "2020-04-12T11:37:15.941Z", "y": 3 }, { "x": "2020-04-12T11:38:15.821Z", "y": 60 }, { "x": "2020-04-12T11:39:02.562Z", "y": 211 }, { "x": "2020-04-12T11:40:00.058Z", "y": 61 }, { "x": "2020-04-12T11:43:51.270Z", "y": 40 }, { "x": "2020-04-12T11:45:00.489Z", "y": 45 }, { "x": "2020-04-12T11:46:43.713Z", "y": 18 }, { "x": "2020-04-12T11:48:27.862Z", "y": 22 }, { "x": "2020-04-12T11:49:02.394Z", "y": 5 }, { "x": "2020-04-12T11:52:46.312Z", "y": 27 }, { "x": "2020-04-12T11:54:09.174Z", "y": 17 }, { "x": "2020-04-12T11:55:00.220Z", "y": 13 }, { "x": "2020-04-12T11:56:37.033Z", "y": 28 }, { "x": "2020-04-12T11:57:00.499Z", "y": 9 }, { "x": "2020-04-12T12:02:08.023Z", "y": 2 }, { "x": "2020-04-12T12:05:25.439Z", "y": 2 }, { "x": "2020-04-12T12:06:00.185Z", "y": 6 }, { "x": "2020-04-12T12:07:34.030Z", "y": 8 }, { "x": "2020-04-12T12:08:47.786Z", "y": 1 }, { "x": "2020-04-12T12:09:04.465Z", "y": 29 }, { "x": "2020-04-12T12:11:40.379Z", "y": 2 }, { "x": "2020-04-12T12:13:15.746Z", "y": 18 }, { "x": "2020-04-12T12:14:10.835Z", "y": 14 }, { "x": "2020-04-12T12:15:50.757Z", "y": 2 }, { "x": "2020-04-12T12:16:15.585Z", "y": 18 }, { "x": "2020-04-12T12:21:32.343Z", "y": 3 }, { "x": "2020-04-12T12:22:05.870Z", "y": 18 }, { "x": "2020-04-12T12:23:03.747Z", "y": 3 }, { "x": "2020-04-12T12:24:16.551Z", "y": 8 }, { "x": "2020-04-12T12:42:38.920Z", "y": 13 }, { "x": "2020-04-12T12:43:17.122Z", "y": 1 }, { "x": "2020-04-12T12:45:06.570Z", "y": 1 }, { "x": "2020-04-12T12:48:00.872Z", "y": 2 }, { "x": "2020-04-12T12:49:20.399Z", "y": 2 }, { "x": "2020-04-12T12:56:49.788Z", "y": 1 }, { "x": "2020-04-12T12:57:24.731Z", "y": 1 }, { "x": "2020-04-12T13:00:31.924Z", "y": 2 }, { "x": "2020-04-12T13:06:05.791Z", "y": 10 }, { "x": "2020-04-12T13:07:00.019Z", "y": 37 }, { "x": "2020-04-12T13:08:24.914Z", "y": 7 }, { "x": "2020-04-12T13:09:32.346Z", "y": 21 }, { "x": "2020-04-12T13:10:01.981Z", "y": 6 }, { "x": "2020-04-12T13:11:40.552Z", "y": 75 }, { "x": "2020-04-12T13:12:19.704Z", "y": 111 }, { "x": "2020-04-12T13:13:00.387Z", "y": 139 }, { "x": "2020-04-12T13:14:00.707Z", "y": 132 }, { "x": "2020-04-12T13:15:00.249Z", "y": 56 }, { "x": "2020-04-12T13:17:05.882Z", "y": 51 }, { "x": "2020-04-12T13:18:00.045Z", "y": 12 }, { "x": "2020-04-12T13:24:39.771Z", "y": 4 }, { "x": "2020-04-12T13:27:16.153Z", "y": 4 }, { "x": "2020-04-12T13:28:41.989Z", "y": 5 }, { "x": "2020-04-12T13:29:21.746Z", "y": 6 }, { "x": "2020-04-12T13:30:09.164Z", "y": 26 }, { "x": "2020-04-12T13:31:44.214Z", "y": 18 }, { "x": "2020-04-12T13:32:54.131Z", "y": 1 }, { "x": "2020-04-12T13:35:28.982Z", "y": 25 }, { "x": "2020-04-12T13:41:48.386Z", "y": 6 }, { "x": "2020-04-12T13:42:00.327Z", "y": 9 }, { "x": "2020-04-12T13:43:34.337Z", "y": 17 }]

    data = data.map((val) => {
        return [val.x, val.y]
    })

    // 指定图表的配置项和数据
    var option = {
        xAxis: {
            type: 'time'
        },
        yAxis: {
            type: 'value'
        },
        series: [{
            data: data,
            type: 'line'
        }]
    };


    // 使用刚指定的配置项和数据显示图表。
    myChart.setOption(option);

    var ws = new WebSocket('ws://127.0.0.1:3000');

    ws.onclose = function (e) {
        // 重连处理
        console.log("服务器关闭");
    }
    ws.onerror = function () {
        console.log("连接出错");
    }

    ws.onmessage = function (e) {
        let data = JSON.parse(e.data)
        // 最后一项合并
        let last = option.series[0].data[option.series[0].data.length - 1]
        if (last[0] == data[0]) {
            // 更新
            option.series[0].data[option.series[0].data.length - 1] = data
        } else {
            // 下一分钟,添加
            option.series[0].data.push(data)
        }
        console.log(option, data)
        myChart.setOption(option);
    }
</script>

</html>